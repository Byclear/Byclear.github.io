<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0 minimal-ui">

<title>鼎曦网络</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link href="css/css.css" rel="stylesheet">
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.9.1.js"></script>
<script>
	$(document).ready(function(){
		function supernatantToggle() {
			if($('.supernatant').css('display') == 'none') {
				$('.supernatant').show();
				$('.transparency').show();
				$('.nearby').children('span').html('∧');
				$('.smart').children('span').html('∨');
			} else {
				$('.supernatant').hide();
				$('.transparency').hide();
				$('.nearby').children('span').html('∨');
				$('.smart').children('span').html('∧');
			}
		}
		$('.nearby').click(function(){
			supernatantToggle();
		});
		$('.smart').click(function(){
			supernatantToggle();
		});
		$('.nearby-add > ul > li').click(function(){
			$('.nearby-add > ul > li').attr('class','');
			$(this).attr('class','active');
		});
		$('.smart-range > ul > li').click(function(){
			$('.smart-range > ul > li').attr('class','');
			$(this).attr('class','active');
		});
	});
</script>
</head>
<body>
    <div class="header">
    	<div class="location">
    		<a class="address" href="javascript:;" target="_blank" rel="external">
	    		<ul>
	    			<li class="ative">深圳</li>
	    			<li>广州</li>
	    			<li>珠海</li>
	    		</ul>
	    		<span>∨</span>	
    		</a>
    	</div>
    	<div class="name">酒吧街</div>
    	<div class="search">
    		<a href="javascript:;" target="_blank" rel="external"></a>
    	</div>
    </div>
    <div class="nav">
    	<div class="nearby">附近<span>∨</span></div>
    	<div class="sep">|</div>
    	<div class="smart">智能<span>∧</span></div>
    </div>
    <div class="supernatant">
    	<div class="nearby-add">
    		<ul>
    			<li class="active">附近</li>
    			<li>全城热门商区</li>
    			<li>宝安区</li>
    			<li>福田区</li>
    			<li>南山区</li>
    			<li>罗湖区</li>
    		</ul>
    	</div>
    	<div class="smart-range">
    		<ul>
    			<li class="active">附近(职能范围)</li>
    			<li>500米</li>
    			<li>1000米</li>
    			<li>2000米</li>
    			<li>5000米</li>
    		</ul>
    	</div>
    </div>
    <div class="transparency"></div>
    <div id="container">
    </div>
    <div class="footer">
    	<div class="game"></div>
    	<div class="pub-street"></div>
    	<div class="personal"></div>
    </div>
    <script>
var waterFall = {
	container: document.getElementById("container"),
	columnNumber: 2,
	columnWidth: 190,
	// P_001.jpg ~ P_160.jpg
	rootImage: "img/",
	indexImage: 0,
	
	scrollTop: document.documentElement.scrollTop || document.body.scrollTop,
	detectLeft: 0,
	
	loadFinish: false,
	
	// 返回固定格式的图片名
	getIndex: function() {
		var index = this.indexImage;
		if (index < 10) {
			index = "00" + index;	
		} else if (index < 100) {
			index = "0" + index;	
		}
		return index;
	},
	
	// 是否滚动载入的检测
	appendDetect: function() {
		var start = 0;
		for (start; start < this.columnNumber; start++) {
			var eleColumn = document.getElementById("waterFallColumn_" + start);
			if (eleColumn && !this.loadFinish) {
				if (eleColumn.offsetTop + eleColumn.clientHeight < this.scrollTop + (window.innerHeight || document.documentElement.clientHeight)) {
					this.append(eleColumn);
				}
			}			
		}
		
		return this;
	},
	
	// 滚动载入
	append: function(column) {
		this.indexImage += 1;
		var html = '', index = this.getIndex(), imgUrl = this.rootImage + "P_" + index + ".jpg";
		
		// 图片尺寸
		var aEle = document.createElement("a");
		aEle.href = "###";
		aEle.className = "pic_a";
		aEle.innerHTML = '<img src="'+ imgUrl +'" /><strong>'+ index +'</strong>';
		column.appendChild(aEle);
		
		if (index >= 160) {
			//alert("图片加载光光了！");
			this.loadFinish = true;
		}
		
		return this;
	},
	
	// 页面加载初始创建
	create: function() {
		this.columnNumber = Math.floor(document.body.clientWidth / this.columnWidth);
		if(document.body.clientWidth<480) {
			this.columnNumber = 2;
		} 
		this.columnWidth = Math.floor(document.body.clientWidth/this.columnNumber)-7;
		var start = 0, htmlColumn = '', self = this;
		for (start; start < this.columnNumber; start+=1) {
			htmlColumn = htmlColumn + '<span id="waterFallColumn_'+ start +'" class="column" style="width:'+ this.columnWidth +'px;">'+ 
				function() {
					var html = '', i = 0;
					for (i=0; i<5; i+=1) {
						self.indexImage = start + self.columnNumber * i;
						var index = self.getIndex();
						html = html + '<a href="javascript:void(0);" class="pic_a"><img src="'+ self.rootImage + "P_" + index +'.jpg" /><div class="info"><div class="logo"><img src="img/pub-street.jpg"></div><div class="info-content"><span>成都本色酒吧</span><span>人气3456<span></div></div></a>';
					}
					return html;	
				}() +
			'</span> ';	
		}
		htmlColumn += '<span id="waterFallDetect" class="column" style="width:'+ this.columnWidth +'px;"></span>';
		
		this.container.innerHTML = htmlColumn;
		
		this.detectLeft = document.getElementById("waterFallDetect").offsetLeft;
		return this;
	},
	
	refresh: function() {
		var arrHtml = [], arrTemp = [], htmlAll = '', start = 0, maxLength = 0;
		for (start; start < this.columnNumber; start+=1) {
			var arrColumn = document.getElementById("waterFallColumn_" + start).innerHTML.match(/<a(?:.|\n|\r|\s)*?a>/gi);
			if (arrColumn) {
				maxLength = Math.max(maxLength, arrColumn.length);
				// arrTemp是一个二维数组
				arrTemp.push(arrColumn);
			}
		}
		
		// 需要重新排序
		var lengthStart, arrStart;
		for (lengthStart = 0; lengthStart<maxLength; lengthStart++) {
			for (arrStart = 0; arrStart<this.columnNumber; arrStart++) {
				if (arrTemp[arrStart][lengthStart]) {
					arrHtml.push(arrTemp[arrStart][lengthStart]);	
				}
			}	
		}
		
		
		if (arrHtml && arrHtml.length !== 0) {
			// 新栏个数		
			this.columnNumber = Math.floor(document.body.clientWidth / this.columnWidth);
			
			// 计算每列的行数
			// 向下取整
			var line = Math.floor(arrHtml.length / this.columnNumber);
			
			// 重新组装HTML
			var newStart = 0, htmlColumn = '', self = this;
			for (newStart; newStart < this.columnNumber; newStart+=1) {
				htmlColumn = htmlColumn + '<span id="waterFallColumn_'+ newStart +'" class="column" style="width:'+ this.columnWidth +'px;">'+ 
					function() {
						var html = '', i = 0;
						for (i=0; i<line; i+=1) {
							html += arrHtml[newStart + self.columnNumber * i];
						}
						// 是否补足余数
						html = html + (arrHtml[newStart + self.columnNumber * line] || '');
						
						return html;	
					}() +
				'</span> ';	
			}
			htmlColumn += '<span id="waterFallDetect" class="column" style="width:'+ this.columnWidth +'px;"></span>';
		
			this.container.innerHTML = htmlColumn;
			
			this.detectLeft = document.getElementById("waterFallDetect").offsetLeft;
			
			// 检测
			this.appendDetect();
		}
		return this;
	},
	
	// 滚动加载
	scroll: function() {
		var self = this;
		window.onscroll = function() {
			// 为提高性能，滚动前后距离大于100像素再处理
			var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
			if (!this.loadFinish && Math.abs(scrollTop - self.scrollTop) > 100) {
				self.scrollTop = scrollTop;
				self.appendDetect();	
			}
			
		};
		return this;
	},
	
	// 浏览器窗口大小变换
	resize: function() {
		var self = this;
		window.onresize = function() {
			var eleDetect = document.getElementById("waterFallDetect"), detectLeft = eleDetect && eleDetect.offsetLeft;
			if (detectLeft && Math.abs(detectLeft - self.detectLeft) > 50) {
				// 检测标签偏移异常，认为布局要改变
				self.refresh();	
			}
		};
		return this;
	},
	init: function() {
		if (this.container) {
			this.create().scroll().resize();	
		}
	}
};
waterFall.init();
</script>
</body>
</html>